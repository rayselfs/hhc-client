name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-14, windows-2025]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for version detection

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build and Release (macOS)
        if: matrix.os == 'macos-14'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          # 如果有 Apple Developer ID，可以添加以下環境變數
          # CSC_NAME: ${{ secrets.CSC_NAME }}
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          npm run electron:build:mac-arm -- --publish always
          npm run electron:build:mac-intel -- --publish always

      - name: Build and Release (Windows)
        if: matrix.os == 'windows-2025'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          npm run electron:build:win -- --publish always

      - name: Upload release artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: release/**
          retention-days: 30

  upload-to-gitee:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download artifacts from GitHub Release
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release-files

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Upload to Gitee Releases
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          from pathlib import Path

          GITEE_TOKEN = os.environ.get('GITEE_TOKEN')
          GITEE_USERNAME = os.environ.get('GITEE_USERNAME')
          VERSION = os.environ.get('VERSION', '1.0.0')
          REPO = 'hhc-client'
          TAG_NAME = f'v{VERSION}'

          if not GITEE_TOKEN or not GITEE_USERNAME:
              print("GITEE_TOKEN or GITEE_USERNAME not set, skipping Gitee upload")
              exit(0)

          headers = {
              'Authorization': f'token {GITEE_TOKEN}',
              'Content-Type': 'application/json'
          }

          # Create or get release
          release_url = f'https://gitee.com/api/v5/repos/{GITEE_USERNAME}/{REPO}/releases'

          # Check if release exists
          try:
              releases_response = requests.get(f'{release_url}/tags/{TAG_NAME}', headers=headers, timeout=10)
              if releases_response.status_code == 404:
                  # Create release
                  release_data = {
                      'tag_name': TAG_NAME,
                      'name': f'Release {TAG_NAME}',
                      'body': f'Release {TAG_NAME}\n\nAuto-synced from GitHub',
                      'prerelease': False
                  }
                  create_response = requests.post(release_url, headers=headers, json=release_data, timeout=30)
                  if create_response.status_code not in [200, 201]:
                      print(f"Failed to create release: {create_response.text}")
                      exit(1)
                  release_id = create_response.json()['id']
              else:
                  release_id = releases_response.json()['id']
          except Exception as e:
              print(f"Error checking/creating release: {e}")
              exit(1)

          # Upload files from release directory
          release_dir = Path('release-files')
          uploaded_count = 0
          if release_dir.exists():
              for file_path in release_dir.rglob('*'):
                  if file_path.is_file():
                      print(f"Uploading {file_path.name}...")
                      upload_url = f'https://gitee.com/api/v5/repos/{GITEE_USERNAME}/{REPO}/releases/{release_id}/attach_files'
                      
                      try:
                          with open(file_path, 'rb') as f:
                              files = {'file': (file_path.name, f, 'application/octet-stream')}
                              upload_headers = {'Authorization': f'token {GITEE_TOKEN}'}
                              upload_response = requests.post(upload_url, headers=upload_headers, files=files, timeout=300)
                              if upload_response.status_code in [200, 201]:
                                  print(f"Successfully uploaded {file_path.name}")
                                  uploaded_count += 1
                              else:
                                  print(f"Failed to upload {file_path.name}: {upload_response.status_code} - {upload_response.text}")
                      except Exception as e:
                          print(f"Error uploading {file_path.name}: {e}")

          print(f"Gitee release upload completed. Uploaded {uploaded_count} files.")
          EOF

      - name: Sync code to Gitee (optional)
        if: env.GITEE_SSH_PRIVATE_KEY != ''
        uses: wearerequired/git-mirror-action@master
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_SSH_PRIVATE_KEY }}
        with:
          source-repo: ${{ github.repository }}
          destination-repo: ${{ secrets.GITEE_USERNAME }}/hhc-client

name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  build:
    needs: prepare
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-14, windows-2025]

    env:
      BUILD_VERSION: ${{ needs.prepare.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and Release (macOS)
        if: matrix.os == 'macos-14'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          # 如果有 Apple Developer ID，可以添加以下環境變數
          # CSC_NAME: ${{ secrets.CSC_NAME }}
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          npm run electron:build:mac-arm -- --publish always
          npm run electron:build:mac-intel -- --publish always

      - name: Build and Release (Windows)
        if: matrix.os == 'windows-2025'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          npm run electron:build:win -- --publish always

      - name: Upload release artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: release/**
          retention-days: 30

  upload-to-gitee:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: success()

    env:
      # 將 Secrets 設置為 Job 環境變數
      GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
      VERSION: ${{ needs.prepare.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 確保獲取所有 tags，以便鏡像同步
          fetch-depth: 0

      - name: Download artifacts from GitHub Release
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release-files

      - name: Upload to Gitee Releases (using Shell)
        run: |
          set -e # 如果有命令失敗，立即退出

          # 1. 設置變量
          # 環境變數已由 env: 區塊設定
          REPO="hhc-client" # 您的 Gitee repo 名稱
          TAG_NAME="v$VERSION"

          # 檢查 Secrets 是否設置
          if [ -z "$GITEE_TOKEN" ] || [ -z "$GITEE_USERNAME" ]; then
            echo "GITEE_TOKEN or GITEE_USERNAME not set, skipping Gitee upload."
            exit 0
          fi

          API_BASE_URL="https://gitee.com/api/v5/repos/$GITEE_USERNAME/$REPO"
          AUTH_HEADER="Authorization: token $GITEE_TOKEN"

          # 2. 檢查或創建 Release
          echo "Checking for existing Gitee release for tag $TAG_NAME..."

          HTTP_STATUS=$(curl -s -H "$AUTH_HEADER" \
            -o gitee_response.json \
            -w "%{http_code}" \
            "$API_BASE_URL/releases/tags/$TAG_NAME")
            
          BODY=$(cat gitee_response.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Release found."
            RELEASE_ID=$(echo "$BODY" | jq -r '.id')
          elif [ "$HTTP_STATUS" -eq 404 ]; then
            echo "Release not found. Creating new release..."
            
            JSON_PAYLOAD=$(jq -n \
              --arg tag "$TAG_NAME" \
              --arg name "Release $TAG_NAME" \
              --arg body "Release $TAG_NAME\n\nAuto-synced from GitHub" \
              '{tag_name: $tag, name: $name, body: $body, prerelease: false}')
              
            CREATE_BODY=$(curl -s -X POST \
              -H "$AUTH_HEADER" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD" \
              "$API_BASE_URL/releases")
              
            RELEASE_ID=$(echo "$CREATE_BODY" | jq -r '.id')
            if [ "$RELEASE_ID" == "null" ] || [ -z "$RELEASE_ID" ]; then
              echo "Failed to create release. Response: $CREATE_BODY"
              exit 1
            fi
            echo "Release created with ID: $RELEASE_ID"
          else
            echo "Failed to check Gitee release. Status: $HTTP_STATUS, Body: $BODY"
            exit 1
          fi

          if [ "$RELEASE_ID" == "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "Could not determine RELEASE_ID."
            exit 1
          fi

          # 3. 上傳檔案
          echo "Uploading files to Gitee release $RELEASE_ID..."
          UPLOAD_COUNT=0
          RELEASE_DIR="release-files"

          find "$RELEASE_DIR" -type f -print0 | while IFS= read -r -d '' FILE; do
            FILENAME=$(basename "$FILE")
            echo "Uploading $FILENAME..."
            
            UPLOAD_RESPONSE=$(curl -s -X POST \
              -H "$AUTH_HEADER" \
              -F "file=@$FILE" \
              "$API_BASE_URL/releases/$RELEASE_ID/attach_files")
              
            if echo "$UPLOAD_RESPONSE" | jq -e '.name != null' > /dev/null; then
              echo "Successfully uploaded $FILENAME"
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            else
              echo "Failed to upload $FILENAME. Response: $UPLOAD_RESPONSE"
              # 允許繼續上傳其他檔案，不在此處 exit 1
            fi
          done

          echo "Gitee release upload completed. Uploaded $UPLOAD_COUNT files."

      - name: Sync code to Gitee (optional)
        if: success()
        uses: wearerequired/git-mirror-action@master
        env:
          # GITHUB_TOKEN 是 GitHub Actions 自動提供的
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITEE_TOKEN 和 GITEE_USERNAME 已在 Job 的 env 中定義
        with:
          # 來源 repo (GitHub) - 使用 GITHUB_TOKEN
          source-repo: "https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          # 目的地 repo (Gitee) - 使用 GITEE_TOKEN
          destination-repo: "https://${{ env.GITEE_USERNAME }}:${{ env.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_USERNAME }}/hhc-client.git"
